# Domain Model

**Last updated:** 24 Oct 2025  
**Source:** `backend/models/core.py` after Phase 3.2 completion.

This chapter describes the persisted entities, enumerations, and relationships that make up UNOC's FTTH topology model.

## Enumerations
| Enum | Location | Values | Notes |
|------|----------|--------|-------|
| `Status` | `backend/models/core.py:19` | `UP`, `DOWN`, `DEGRADED` | Shared by devices, interfaces, and links. |
| `DeviceType` | `backend/models/core.py:27` | 14 device roles (active, container, passive) | Drives provisioning rules and UI rendering. |
| `InterfaceType` | `backend/models/core.py:65` | `ETHERNET`, `OPTICAL`, `LOOPBACK` | Used when creating interfaces manually or through provisioning. |

## Entities
### Device (`backend/models/core.py:86`)
| Field | Type | Notes |
|-------|------|-------|
| `id` | int (PK) | Auto-increment primary key. |
| `name` | str | Unique; required for provisioning. |
| `device_type` | `DeviceType` | Selects interface recipe and upstream rules. |
| `status` | `Status` | Operational state computed by backend logic. |
| `status_override` | `Status | None` | Manual override, set via API. |
| `override_reason` | str | Optional free-text reason (max 255 chars). |
| `tx_power_dbm` | float | OLT transmit power. |
| `sensitivity_min_dbm` | float | ONT/BUSINESS_ONT receive sensitivity. |
| `insertion_loss_db` | float | Passive device loss. |
| `parent_container_id` | int | Optional reference to a container device (POP / CORE_SITE). |
| `x`, `y` | float | Canvas coordinates for the frontend. |
| `created_at`, `updated_at` | datetime | Timestamps (UTC). |

Relationships: `interfaces` (one-to-many, cascade delete).

### Interface (`backend/models/core.py:127`)
| Field | Type | Notes |
|-------|------|-------|
| `id` | int (PK) | |
| `name` | str | Auto-generated by provisioning or user-defined. |
| `interface_type` | `InterfaceType` | Aligns with physical medium. |
| `status` | `Status` | Reflects operational state of the port. |
| `device_id` | int (FK) | Cascades on delete with parent device. |

Relationships: `device` (many-to-one), `links_as_a`, `links_as_b`.

### Link (`backend/models/core.py:158`)
| Field | Type | Notes |
|-------|------|-------|
| `id` | int (PK) | |
| `status` | `Status` | Link health. |
| `length_km` | float | Optional physical length. |
| `physical_medium_id` | str | Optional fiber classification (e.g. G652D). |
| `link_loss_db` | float | Optional aggregate optical loss. |
| `a_interface_id` | int (FK) | Endpoint A (`ondelete="CASCADE"`). |
| `b_interface_id` | int (FK) | Endpoint B (`ondelete="CASCADE"`). |
| `created_at`, `updated_at` | datetime | Lifecycle audit fields. |

Relationships: `interface_a`, `interface_b` (bidirectional).

## Cascading Behaviour
- Deleting a device cascades to all interfaces and their links (see `Device.interfaces` relationship).
- Deleting a link removes only that record; interfaces remain intact.
- Interface records cannot exist without a device, thanks to the foreign key constraint.

## Example: Provisioning then inspecting interfaces
```python
from backend.models.core import DeviceType, Device
from backend.services.provisioning_service import ProvisioningService

service = ProvisioningService(session)

device = await service.provision_device(
    name="olt-001",
    device_type=DeviceType.OLT,
    tx_power_dbm=5.0,
)

interfaces = await service.get_device_interfaces(device.id)
print(device.name, [iface.name for iface in interfaces])
# -> olt-001 ['mgmt0', 'lo0', 'pon0', 'pon1', 'pon2', 'pon3', 'pon4', 'pon5', 'pon6', 'pon7']
```

## Status Override Fields
- `status_override` and `override_reason` live on the `Device` model so manual actions are durable.
- The canonical API endpoints are documented in `docs/03_status_and_overrides.md`.

## References
- `backend/models/core.py:19` - Enumeration definitions.
- `backend/models/core.py:86` - Device model and relationships.
- `backend/models/core.py:127` - Interface model.
- `backend/models/core.py:158` - Link model.
- `backend/services/provisioning_service.py:52` - Service that populates devices and interfaces.
